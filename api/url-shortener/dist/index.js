"use strict";var t=require("util"),e=require("fs"),r=require("os"),n=require("path"),i=require("crypto"),o=require("assert");function a(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var c=a(t),s=a(e),l=a(r),u=a(n),f=a(i),d={exports:{}},p={exports:{}};const m=a(o).default,y=u.default,h=s.default;let E;try{E=require("glob")}catch(t){}const b={nosort:!0,silent:!0};let w=0;const x="win32"===process.platform,N=t=>{if(["unlink","chmod","stat","lstat","rmdir","readdir"].forEach((e=>{t[e]=t[e]||h[e],t[e+="Sync"]=t[e]||h[e]})),t.maxBusyTries=t.maxBusyTries||3,t.emfileWait=t.emfileWait||1e3,!1===t.glob&&(t.disableGlob=!0),!0!==t.disableGlob&&void 0===E)throw Error("glob dependency not found, set `options.disableGlob = true` if intentional");t.disableGlob=t.disableGlob||!1,t.glob=t.glob||b},v=(t,e,r)=>{"function"==typeof e&&(r=e,e={}),m(t,"rimraf: missing path"),m.equal(typeof t,"string","rimraf: path should be a string"),m.equal(typeof r,"function","rimraf: callback function required"),m(e,"rimraf: invalid options argument provided"),m.equal(typeof e,"object","rimraf: options should be object"),N(e);let n=0,i=null,o=0;const a=(t,a)=>t?r(t):(o=a.length,0===o?r():void a.forEach((t=>{const a=c=>{if(c){if(("EBUSY"===c.code||"ENOTEMPTY"===c.code||"EPERM"===c.code)&&n<e.maxBusyTries)return n++,setTimeout((()=>g(t,e,a)),100*n);if("EMFILE"===c.code&&w<e.emfileWait)return setTimeout((()=>g(t,e,a)),w++);"ENOENT"===c.code&&(c=null)}w=0,(t=>{i=i||t,0==--o&&r(i)})(c)};g(t,e,a)})));if(e.disableGlob||!E.hasMagic(t))return a(null,[t]);e.lstat(t,((r,n)=>{if(!r)return a(null,[t]);E(t,e.glob,a)}))},g=(t,e,r)=>{m(t),m(e),m("function"==typeof r),e.lstat(t,((n,i)=>n&&"ENOENT"===n.code?r(null):(n&&"EPERM"===n.code&&x&&S(t,e,n,r),i&&i.isDirectory()?T(t,e,n,r):void e.unlink(t,(n=>{if(n){if("ENOENT"===n.code)return r(null);if("EPERM"===n.code)return x?S(t,e,n,r):T(t,e,n,r);if("EISDIR"===n.code)return T(t,e,n,r)}return r(n)})))))},S=(t,e,r,n)=>{m(t),m(e),m("function"==typeof n),e.chmod(t,438,(i=>{i?n("ENOENT"===i.code?null:r):e.stat(t,((i,o)=>{i?n("ENOENT"===i.code?null:r):o.isDirectory()?T(t,e,r,n):e.unlink(t,n)}))}))},O=(t,e,r)=>{m(t),m(e);try{e.chmodSync(t,438)}catch(t){if("ENOENT"===t.code)return;throw r}let n;try{n=e.statSync(t)}catch(t){if("ENOENT"===t.code)return;throw r}n.isDirectory()?R(t,e,r):e.unlinkSync(t)},T=(t,e,r,n)=>{m(t),m(e),m("function"==typeof n),e.rmdir(t,(i=>{!i||"ENOTEMPTY"!==i.code&&"EEXIST"!==i.code&&"EPERM"!==i.code?i&&"ENOTDIR"===i.code?n(r):n(i):D(t,e,n)}))},D=(t,e,r)=>{m(t),m(e),m("function"==typeof r),e.readdir(t,((n,i)=>{if(n)return r(n);let o,a=i.length;if(0===a)return e.rmdir(t,r);i.forEach((n=>{v(y.join(t,n),e,(n=>{if(!o)return n?r(o=n):void(0==--a&&e.rmdir(t,r))}))}))}))},k=(t,e)=>{let r;if(N(e=e||{}),m(t,"rimraf: missing path"),m.equal(typeof t,"string","rimraf: path should be a string"),m(e,"rimraf: missing options"),m.equal(typeof e,"object","rimraf: options should be object"),e.disableGlob||!E.hasMagic(t))r=[t];else try{e.lstatSync(t),r=[t]}catch(n){r=E.sync(t,e.glob)}if(r.length)for(let t=0;t<r.length;t++){const n=r[t];let i;try{i=e.lstatSync(n)}catch(t){if("ENOENT"===t.code)return;"EPERM"===t.code&&x&&O(n,e,t)}try{i&&i.isDirectory()?R(n,e,null):e.unlinkSync(n)}catch(t){if("ENOENT"===t.code)return;if("EPERM"===t.code)return x?O(n,e,t):R(n,e,t);if("EISDIR"!==t.code)throw t;R(n,e,t)}}},R=(t,e,r)=>{m(t),m(e);try{e.rmdirSync(t)}catch(n){if("ENOENT"===n.code)return;if("ENOTDIR"===n.code)throw r;"ENOTEMPTY"!==n.code&&"EEXIST"!==n.code&&"EPERM"!==n.code||$(t,e)}},$=(t,e)=>{m(t),m(e),e.readdirSync(t).forEach((r=>k(y.join(t,r),e)));const r=x?100:1;let n=0;for(;;){let i=!0;try{const o=e.rmdirSync(t,e);return i=!1,o}finally{if(++n<r&&i)continue}}};var q=v;v.sync=k,
/*!
 * Tmp
 *
 * Copyright (c) 2011-2017 KARASZI Istvan <github@spam.raszi.hu>
 *
 * MIT Licensed
 */
function(t){const e=s.default,r=l.default,n=u.default,i=f.default,o={fs:e.constants,os:r.constants},a=q,c="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",d=/XXXXXX/,p=(o.O_CREAT||o.fs.O_CREAT)|(o.O_EXCL||o.fs.O_EXCL)|(o.O_RDWR||o.fs.O_RDWR),m="win32"===r.platform(),y=o.EBADF||o.os.errno.EBADF,h=o.ENOENT||o.os.errno.ENOENT,E=[],b=e.rmdirSync.bind(e),w=a.sync;let x=!1;function N(t,r){const n=j(t,r),i=n[0],o=n[1];try{M(i)}catch(t){return o(t)}let a=i.tries;!function t(){try{const r=C(i);e.stat(r,(function(e){if(!e)return a-- >0?t():o(new Error("Could not get a unique tmp filename, max tries reached "+r));o(null,r)}))}catch(t){o(t)}}()}function v(t){const r=j(t)[0];M(r);let n=r.tries;do{const t=C(r);try{e.statSync(t)}catch(e){return t}}while(n-- >0);throw new Error("Could not get a unique tmp filename, max tries reached")}function g(t,r){const n=function(t){if(t&&!G(t))return r(t);r()};0<=t[0]?e.close(t[0],(function(){e.unlink(t[1],n)})):e.unlink(t[1],n)}function S(t){let r=null;try{0<=t[0]&&e.closeSync(t[0])}catch(t){if(!(n=t,X(n,-y,"EBADF")||G(t)))throw t}finally{try{e.unlinkSync(t[1])}catch(t){G(t)||(r=t)}}var n;if(null!==r)throw r}function O(t,e,r,n){const i=D(S,[e,t],n),o=D(g,[e,t],n,i);return r.keep||E.unshift(i),n?i:o}function T(t,r,n){const i=r.unsafeCleanup?a:e.rmdir.bind(e),o=D(r.unsafeCleanup?w:b,t,n),c=D(i,t,n,o);return r.keep||E.unshift(o),n?o:c}function D(t,e,r,n){let i=!1;return function o(a){if(!i){const c=n||o,s=E.indexOf(c);return s>=0&&E.splice(s,1),i=!0,r||t===b||t===w?t(e):t(e,a||function(){})}}}function k(t){let e=[],r=null;try{r=i.randomBytes(t)}catch(e){r=i.pseudoRandomBytes(t)}for(var n=0;n<t;n++)e.push(c[r[n]%c.length]);return e.join("")}function R(t){return null===t||$(t)||!t.trim()}function $(t){return void 0===t}function j(t,e){if("function"==typeof t)return[{},t];if($(t))return[{},e];const r={};for(const e of Object.getOwnPropertyNames(t))r[e]=t[e];return[r,e]}function C(t){const e=t.tmpdir;if(!$(t.name))return n.join(e,t.dir,t.name);if(!$(t.template))return n.join(e,t.dir,t.template).replace(d,k(6));const r=[t.prefix?t.prefix:"tmp","-",process.pid,"-",k(12),t.postfix?"-"+t.postfix:""].join("");return n.join(e,t.dir,r)}function M(t){t.tmpdir=W(t);const e=t.tmpdir;if($(t.name)||B(t.name,"name",e),$(t.dir)||B(t.dir,"dir",e),!$(t.template)&&(B(t.template,"template",e),!t.template.match(d)))throw new Error(`Invalid template, found "${t.template}".`);if(!$(t.tries)&&isNaN(t.tries)||t.tries<0)throw new Error(`Invalid tries, found "${t.tries}".`);t.tries=$(t.name)?t.tries||3:1,t.keep=!!t.keep,t.detachDescriptor=!!t.detachDescriptor,t.discardDescriptor=!!t.discardDescriptor,t.unsafeCleanup=!!t.unsafeCleanup,t.dir=$(t.dir)?"":n.relative(e,I(t.dir,e)),t.template=$(t.template)?void 0:n.relative(e,I(t.template,e)),t.template=R(t.template)?void 0:n.relative(t.dir,t.template),t.name=$(t.name)?void 0:P(t.name),t.prefix=$(t.prefix)?"":t.prefix,t.postfix=$(t.postfix)?"":t.postfix}function I(t,e){const r=P(t);return r.startsWith(e)?n.resolve(r):n.resolve(n.join(e,r))}function P(t){return R(t)?t:t.replace(/["']/g,"")}function B(t,e,r){if("name"===e){if(n.isAbsolute(t))throw new Error(`${e} option must not contain an absolute path, found "${t}".`);let r=n.basename(t);if(".."===r||"."===r||r!==t)throw new Error(`${e} option must not contain a path, found "${t}".`)}else{if(n.isAbsolute(t)&&!t.startsWith(r))throw new Error(`${e} option must be relative to "${r}", found "${t}".`);let i=I(t,r);if(!i.startsWith(r))throw new Error(`${e} option must be relative to "${r}", found "${i}".`)}}function G(t){return X(t,-h,"ENOENT")}function X(t,e,r){return m?t.code===r:t.code===r&&t.errno===e}function W(t){return n.resolve(P(t&&t.tmpdir||r.tmpdir()))}process.addListener("exit",(function(){if(x)for(;E.length;)try{E[0]()}catch(t){}})),Object.defineProperty(t.exports,"tmpdir",{enumerable:!0,configurable:!1,get:function(){return W()}}),t.exports.dir=function(t,r){const n=j(t,r),i=n[0],o=n[1];N(i,(function(t,r){if(t)return o(t);e.mkdir(r,i.mode||448,(function(t){if(t)return o(t);o(null,r,T(r,i,!1))}))}))},t.exports.dirSync=function(t){const r=j(t)[0],n=v(r);return e.mkdirSync(n,r.mode||448),{name:n,removeCallback:T(n,r,!0)}},t.exports.file=function(t,r){const n=j(t,r),i=n[0],o=n[1];N(i,(function(t,r){if(t)return o(t);e.open(r,p,i.mode||384,(function(t,n){if(t)return o(t);if(i.discardDescriptor)return e.close(n,(function(t){return o(t,r,void 0,O(r,-1,i,!1))}));{const t=i.discardDescriptor||i.detachDescriptor;o(null,r,n,O(r,t?-1:n,i,!1))}}))}))},t.exports.fileSync=function(t){const r=j(t)[0],n=r.discardDescriptor||r.detachDescriptor,i=v(r);var o=e.openSync(i,p,r.mode||384);return r.discardDescriptor&&(e.closeSync(o),o=void 0),{name:i,fd:o,removeCallback:O(i,n?-1:o,r,!0)}},t.exports.tmpName=N,t.exports.tmpNameSync=v,t.exports.setGracefulCleanup=function(){x=!0}}(p),function(t){const{promisify:e}=c.default,r=p.exports;t.exports.fileSync=r.fileSync;const n=e(((t,n)=>r.file(t,((t,r,i,o)=>t?n(t):n(void 0,{path:r,fd:i,cleanup:e(o)})))));t.exports.file=async t=>n(t),t.exports.withFile=async function(e,r){const{path:n,fd:i,cleanup:o}=await t.exports.file(r);try{return await e({path:n,fd:i})}finally{await o()}},t.exports.dirSync=r.dirSync;const i=e(((t,n)=>r.dir(t,((t,r,i)=>t?n(t):n(void 0,{path:r,cleanup:e(i)})))));t.exports.dir=async t=>i(t),t.exports.withDir=async function(e,r){const{path:n,cleanup:i}=await t.exports.dir(r);try{return await e({path:n})}finally{await i()}},t.exports.tmpNameSync=r.tmpNameSync,t.exports.tmpName=e(r.tmpName),t.exports.tmpdir=r.tmpdir,t.exports.setGracefulCleanup=r.setGracefulCleanup}(d);module.exports=({action:t},{services:e,getSchema:r,exceptions:n})=>{const i=t=>{let e="";return"/"===t.at(-1)?t:(e=`${t}/`,e)},{ItemsService:o,FilesService:a}=e,{ServiceUnavailableException:c}=n;t("urls.items.create",(async(t,{accountability:e})=>{const n=()=>{let t=Math.random().toString(36).substr(2,5);return null!==u&&u.forEach((e=>{e.slug===t&&n()})),t},s=new o("urls",{accountability:e,schema:await r()}),l=new a({schema:await r()}),u=await s.readByQuery({fields:["slug"]}),f=n(),p=require("fs"),{path:m,cleanup:y}=await d.exports.file();try{if(void 0===t.payload.slug){const r=await l.uploadOne(p.createReadStream(m),{storage:"s3",filename_disk:`${f}.txt`,filename_download:`${f}.txt`,title:f,type:"text/plain",uploaded_by:e.user,filesize:0,metadata:{"x-amz-website-redirect-location":`${i(t.payload.domain)}${f}`}});await s.updateOne(t.key,{slug:f,redirection:r})}else await l.updateOne(t.payload.redirection,{metadata:{"x-amz-website-redirect-location":`${i(t.payload.domain)}${t.payload.slug}`}})}catch(t){throw new c(t)}finally{await y()}}))};
